include: 'https://raw.githubusercontent.com/kinhnv/System.CommonPipeline/main/.prepare-ssh.yml'

variables:
  VERSION: "$CI_PIPELINE_ID"
  ASPNETCORE_ENVIRONMENT: "Production"

stages:
  - build
  - test
  - deploy

.build_tags:
  tags:
    - "shell"

.test_tags:
  tags:
    - "docker"

.deploy_tags:
  tags:
    - "shell"

build:
  stage: build
  extends:
    - .build_tags
  only:
    - main
  before_script:
    - sed -i "s/pre-build-params_registry/$REGISTRY/g" ./**/Dockerfile
    - sed -i "s/pre-build-params_github-source-username/$GITHUB_SOURCE_USERNAME/g" ./**/Dockerfile
    - sed -i "s/pre-build-params_github-source-token/$GITHUB_SOURCE_TOKEN/g" ./**/Dockerfile
    - sed -i "s,pre-build-params_github-source-url,$GITHUB_SOURCE_URL,g" ./**/Dockerfile
  script:
    - docker build -t $REGISTRY/user.user-service:${VERSION} ${CI_PROJECT_DIR} -f ${CI_PROJECT_DIR}/UserService.Api/Dockerfile
    - docker push $REGISTRY/user.user-service:${VERSION}
    - docker image rm $REGISTRY/user.user-service:${VERSION}
    
test:
  stage: test
  image: '$REGISTRY/dotnet/sdk:6.0'
  extends:
    - .test_tags
  only:
    - main
  needs: [build]
  script:
    - dotnet nuget add source --username $GITHUB_SOURCE_USERNAME --password $GITHUB_SOURCE_TOKEN --store-password-in-clear-text --name github "$GITHUB_SOURCE_URL"
    - cd UserService.UnitTests
    - dotnet test --logger:"console;verbosity=detailed"
        
deploy:
  stage: deploy
  extends:
    - .deploy_tags
    - .prepare_ssh
  only:
    - main
  needs: [test]
  script:
    - git clone $GITOPS_URL && cd gitops
    - yq eval ".services.eventService.tag = \"${VERSION}\"" -i ./test-maker/values.yaml
    - git add ./test-maker/values.yaml || true
    - git commit -m "change to version $VERSION" || true
    - git push || true
    - cd .. && rm -rf gitops
    - git remote set-url origin $GITHUB_URL
    - >
      if [ `git branch --list main` ]; then
        echo "push to existing branch"; 
        git push -u origin HEAD:main;
      else
        echo "create new branch";
        git checkout -b main; 
        git push -u origin main;
      fi
